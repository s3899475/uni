Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2023-08-10T14:16:52+10:00

====== Week 3 ======

===== Chapter 2 Part 1 =====
Label distribution protocols:
* Resource Reservation Protocol (RSVP)
* Label Distribution Protocol (LDP) - Chapter 3
=== Summary/Comparison ===
== LDP - Chapter 3 ==
* LSPs always follow the best IGP path
	* Does not allow traffic engineering
* Originally designed to offload the forwarding plane
	* Now used by applications requiring a full mesh of LSP between routers

== RSVP - used by Junos ==
* Originally a generic resource-reservation protocol
	* reserved hop by hop
* Used for traffic engineering
	* Allows an explicitly chosen path to be used
* Allows an LSP to reserve bandwidth along the path
* Can be extended to support a number of other features
	* Traffic protection, P2MP, etc.

==== RSVP ====
Signalling protocol, not a routing protocol
=== Message Types ===
== LSP Setup ==
Path: Request for an LSP to be created (or periodic for refresh)
	sent by ingress router
Resv: Reserve resources for LSP
	sent from egress router
	resources, including labels
== LSP tear-down ==
PathTear: Remove path and corresponding reservation state
	sent by ingress router or a router whose path state has timed out (downstream)
ResvTear: Remove path and corresponding reservation state (same)
	sent upstream
== Error handling ==
PathErr: Error message sent upstream to sender
ResvErr: Error message sent downstream

=== Header ===
common header followed by one or more objects
== Objects: ==
* **Session**: uniquely identifies the LSP
* **Session attributes**: Priority, preemption, link/node protection
* **Sender T_Spec**: requested bandwidth reservation
* **RSVP hop**: the previous hop the PATH message traversed
* **Label request**: request for label binding
* **Record route**: lists nodes traversed by the LSP
* **Explicit Route Object** (ERO): used to specify the path the LSP should take

=== Setting up an LSP - Path and RESV messages ===
{{./pasted_image.png?width=1000}}
== RSVP RESV message objects ==
* Session
* Label - label allocated by the previous hop
* STYLE - specifies the reservation style (FF, SE) - later chapters
* Record Route
* RSVP-hop

=== RSVP Session Maintenance ===
state is not permanent - needs to be refreshed
refresh is the same as LSP setup - path and RSVP messages
Default refresh - 30s
	default lifetime is around 2m 37s
can bundle multiple refresh messages together - increases scalability and decreases refresh overhead
	Only works if all routers in the path support the extension (RFC 2961)
== Lifetime equation ==
{{./equation.png?type=equation}}

not good for error detection
better:
* hello message extension - never standardized
* IGP extension - Junos tracks IGP state on interfaces towards RSVP neighbours

=== Explicit Route Object (ERO) ===
Used to influence the path of an LSP
Comprised by a number of hops
	each hop is followed by the qualifier **strict** or **loose**
**loose** - the path must pass through this router, but can have hops beforehand
**strict** - the path must immediately go to this router
**the order of these qualifiers matters**

changes the RSVP setup process
* The router examines the ERO in the PATH message
	* If it cannot fulfil the constrain and the hop has the qualifier loose, it just creates a PATH state and forwards the message on, following the best IGP route **to the next constraint** to be fulfilled
	* The PATH state keeps track of who the previous hop was. Important in reservation phase
* If a router receives a PATH message with an ERO constraint that it can verify, the constraint is removed
* If a router receives a PATH message with a strict constraint at the top of the ERO, two cases are possible:
	* If the router can verify it, the constraint is removes and the PATH message is forwarded on
	* If the router cannot verify the constraint, it sends back a Path-Error
**After this the reserve messages will pass through the same path, but in reverse**
{{./pasted_image001.png?width=1000}}
ERO used:
{R7 loose; R4 strict}

===== Chapter 2 Part 2 =====
=== Record Route Object (RRO) ===
Every node adds to the RRo the address of hte interface on which the PATH message has been received
	The address will become the MPLS next-hop once labels are allocated in the RESV step
The complete RRO object is then sent back in the RESV message so every node, including the ingress, can have full visibility of the path
== loop detection ==
IGP does not allow loops, but EROs can cause an LSP to cross the same node twice, creating a loop
If a node receives a PATH message with one of its local addresses in the RRO, it sends back a PathErr message with one of its local addresses in the RRO, it sends back a PathErr message indicating //Routing Loop Detected//
{{./pasted_image003.png}}

==== RSVP Configuration ====
all RSVP interfaces must also be setup to use MPLS
only ingress router needs RSVP configuration
RSVP LSPs configured under ''protocols mpls''
''no-cspf''
	disable automatic path computation via IGP TE extensions
	Junos will used constrained shortest path first by default

''show mpls lsp ingress name RX-to-RY extensive''
check why an LSP is down

can also auth RSVP with MD5 lol

=== Bandwidth Reservation ===
Each router along the path will check the T_spec object
If there is not enough bandwidth on the outgoing interface, LSP establishment will fail
	Ingress router will be signalled
routers will not police traffic by default

RSVP allows the whole interface bandwidth to be reserved by default
You can decrease or increase (oversubscribe) the preservable by a percentage
''[edit protocols rsvp]''
''interface ge-0/0/x.0 {''
	''subscription 150''
''interface ge-0/0/y.0 {''
	''subscription 80''
for 150% allocation (50% oversubscription) to ge-0/0/x
''show rsvp interface''
to show available bandwidth
{{./pasted_image004.png}}
Static = physical bandwidth
available = bandwidth that can be reserved
available will become negative if subscription is changed beyond what is reserved
reserved = actual assigned bandwidth
Highwater = max reserved bandwidth

== Maximum Transmission Unit (MTU) discovery on RSVP-signalled LSPs ==
* Prevents issues with traffic being black holed when ingress MTU exceeds the MTU of a path element
* Uses the //Adspec// object in PATH messages and //Flowspec// object in RESV messages
* Needs to be enabled on all routers in the path
Configuration:
* MTU discovery
	* ''set protocols mpls path-mtu rsvp mtu-signaling''
* Fragmentation at ingress LSR (requires MTU discovery) - only needs to be configured at ingress
	* ''set protocols mpls path-mtu allow fragmentation''

=== P2MP LSP Configuration ===
allows multicast
P2MP LSPs are signalled as multiple sub LSPs
* one sub LSP for each egress node
* each sub LSP uses the same P2MP session object

=== Bidirection Forwarding Detection (BDF) for RSVP LSPs ===
IGP failure detection
can be enabled on specific LSPs, or all LSPs
can be configured with liberal timers at global level, and aggressive timers for specific LSPs
''[edit protocols mpls]''
''oam {''
	''bfd-liveness-detection {''
		''minimum-interval 300;''
		''multiplier 3;''
		''failure-action teardown;''
	''}''
	''lsp-ping-interval 30;''
''}''
under protocol mpls for global, or under each lsp

=== RSVP Auto-Mesh ===
many MPLS applications require a full mesh of LSPs
* LSPs from any node to any other node
* creates the new LSPs automatically
	* LSPs are triggered by a BGP session coming up to a new node and advertising labelled routes. e.g. for a Layer 3 VPN
	* LSPs are torn down when not needed anymore after a timeout
{{./pasted_image005.png}}
{{./pasted_image006.png}}
Destination prefix parameters typically includes the range for PE loopback addresses
The template may include characteristics like bandwidth reservation and other LSP properties

''show dynamic-tunnels database''
shows auto generated LSPs

=== RSVP Graceful Restart ===
maintains forwarding state during a router restart or reboot
requires helper mode in adjacent nodes - enabled by default
	they send a recovery label to restarting node to recover forwarding state.
	restarting router sends a restart_Cap object with a recovery time set no equal to 0

enable
''set routing-options graceful-restart''
check set
''show rsvp version''

=== Traceoptions Configuration ===
has flags
check the bottom slide in lecture

